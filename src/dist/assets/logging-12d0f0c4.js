import{G as r,d as E,h as u,j as A,T as G,$ as i,i as c,f as m,g as N,k,s as x,af as M,F as a,ag as C}from"./index-9715db87.js";import{g as v}from"./generate_filename-ef5ebf28.js";const h={};h.initialize=function(_){r.active_tab!="logging"&&(r.active_tab="logging");let l=[],d=0,S=0,g=[];if(E.connectionValid){const e=function(){u.send_message(A.MSP_MOTOR,!1,!1,n)},n=function(){i("#content").load("./tabs/logging.html",y)};u.send_message(A.MSP_RC,!1,!1,e)}function y(){c.localizePage(),i("a.log_file").click(b),i("a.logging").click(function(){if(r.connected_to)if(o!=null){const n=i(this).data("clicks");if(n)r.interval_kill_all(),i(".speed").prop("disabled",!1),i(this).text(c.getMessage("loggingStart")),i(this).data("clicks",!n);else if(d=0,S=0,g=[],l=[],i(".properties input:checked").each(function(){l.push(i(this).prop("name"))}),l.length){$();const t=function(){S&&D();for(let f=0;f<l.length;f++,S++)u.send_message(A[l[f]])};r.interval_add("log_data_poll",t,parseInt(i("select.speed").val()),!0),r.interval_add("write_data",function(){g.length&&(s.readyState==0||s.readyState==2?(P(g.join(`
`)),i(".samples").text(d+=g.length),g=[]):console.log("IO having trouble keeping up with the data flow"))},1e3),i(".speed").prop("disabled",!0),i(this).text(c.getMessage("loggingStop")),i(this).data("clicks",n!==!0)}else m(c.getMessage("loggingErrorOneProperty"))}else m(c.getMessage("loggingErrorLogFile"));else m(c.getMessage("loggingErrorNotConnected"))});const e=N("logging_file_entry");e.logging_file_entry&&chrome.fileSystem.restoreEntry(e.logging_file_entry,function(n){k()||(o=n,T(!0))}),r.content_ready(_)}function $(){let e="timestamp";for(let n=0;n<l.length;n++)switch(l[n]){case"MSP_RAW_IMU":e+=",gyroscopeX",e+=",gyroscopeY",e+=",gyroscopeZ",e+=",accelerometerX",e+=",accelerometerY",e+=",accelerometerZ",e+=",magnetometerX",e+=",magnetometerY",e+=",magnetometerZ";break;case"MSP_ATTITUDE":e+=",kinematicsX",e+=",kinematicsY",e+=",kinematicsZ";break;case"MSP_ALTITUDE":e+=",altitude";break;case"MSP_RAW_GPS":e+=",gpsFix",e+=",gpsNumSat",e+=",gpsLat",e+=",gpsLon",e+=",gpsAlt",e+=",gpsSpeed",e+=",gpsGroundCourse";break;case"MSP_ANALOG":e+=",voltage",e+=",amperage",e+=",mAhdrawn",e+=",rssi";break;case"MSP_RC":for(let t=0;t<a.RC.active_channels;t++)e+=`,RC${t}`;break;case"MSP_MOTOR":for(let t=0;t<a.MOTOR_DATA.length;t++)e+=`,Motor${t}`;break;case"MSP_DEBUG":for(let t=0;t<a.SENSOR_DATA.debug.length;t++)e+=`,Debug${t}`;break}P(e)}function D(){let e=C();for(let n=0;n<l.length;n++)switch(l[n]){case"MSP_RAW_IMU":e+=`,${a.SENSOR_DATA.gyroscope}`,e+=`,${a.SENSOR_DATA.accelerometer}`,e+=`,${a.SENSOR_DATA.magnetometer}`;break;case"MSP_ATTITUDE":e+=`,${a.SENSOR_DATA.kinematics[0]}`,e+=`,${a.SENSOR_DATA.kinematics[1]}`,e+=`,${a.SENSOR_DATA.kinematics[2]}`;break;case"MSP_ALTITUDE":e+=`,${a.SENSOR_DATA.altitude}`;break;case"MSP_RAW_GPS":e+=`,${a.GPS_DATA.fix}`,e+=`,${a.GPS_DATA.numSat}`,e+=`,${a.GPS_DATA.lat/1e7}`,e+=`,${a.GPS_DATA.lon/1e7}`,e+=`,${a.GPS_DATA.alt}`,e+=`,${a.GPS_DATA.speed}`,e+=`,${a.GPS_DATA.ground_course}`;break;case"MSP_ANALOG":e+=`,${a.ANALOG.voltage}`,e+=`,${a.ANALOG.amperage}`,e+=`,${a.ANALOG.mAhdrawn}`,e+=`,${a.ANALOG.rssi}`;break;case"MSP_RC":for(let t=0;t<a.RC.active_channels;t++)e+=`,${a.RC.channels[t]}`;break;case"MSP_MOTOR":e+=`,${a.MOTOR_DATA}`;break;case"MSP_DEBUG":e+=`,${a.SENSOR_DATA.debug}`;break}g.push(e)}let o=null,s=null;function b(){const e="log",n="csv",t=v(e,n),f=[{description:`${n.toUpperCase()} files`,extensions:[n]}];chrome.fileSystem.chooseEntry({type:"saveFile",suggestedName:t,accepts:f},function(O){k()||(o=O,chrome.fileSystem.getDisplayPath(o,function(p){console.log(`Log file path: ${p}`)}),chrome.fileSystem.getWritableEntry(o,function(p){chrome.fileSystem.isWritableEntry(p,function(R){R?(o=p,x({logging_file_entry:chrome.fileSystem.retainEntry(o)}),i(".samples").text(0),T()):console.log("File appears to be read only, sorry.")})}))})}function T(e){o.createWriter(function(n){s=n,s.onerror=function(t){console.error(t),i("a.logging").data("clicks")&&i("a.logging").click()},s.onwriteend=function(){i(".size").text(M(s.length))},e&&chrome.fileSystem.getDisplayPath(o,function(t){m(c.getMessage("loggingAutomaticallyRetained",[t]))}),i(".size").text(M(s.length)),chrome.fileSystem.getDisplayPath(o,function(t){i(".name").text(t)})},function(n){console.error(n),e&&(o=null)})}function P(e){s.position<s.length&&s.seek(s.length),s.write(new Blob([`${e}
`],{type:"text/plain"}))}};h.cleanup=function(_){_&&_()};G.logging=h;export{h as logging};
