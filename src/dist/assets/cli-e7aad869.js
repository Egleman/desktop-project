import{G as y,$ as s,i as m,T as C,d as h,C as u,k as A,t as b,e as E,U as G,f as T,W,L as U,B as R}from"./index-9715db87.js";import{C as L}from"./Clipboard-afda6529.js";import{g as _}from"./generate_filename-ef5ebf28.js";const d={lineDelayMs:15,profileSwitchDelayMs:100,outputHistory:"",cliBuffer:"",startProcessing:!1,GUI:{snippetPreviewWindow:null,copyButton:null,windowWrapper:null},lastArrival:0};function P(t){return t.replace(/^# /,"")}function D(t,e){let o=0;for(let i=0;i<e.length&&t[i]===e[i];i++)o++;return e.length-o}function H(t,e,o){return String.fromCharCode(127).repeat(o)+t.substring(e.length-o,t.length)}function x(t,e){const o=P(e),i=new RegExp(`^${o}`,"g");if(t.match(i))return t.replace(i,"");const c=D(t,o);return H(t,o,c)}function O(t){function e(){b.sendEvent(b.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"CliCopyToClipboard",t.length);const i=C.cli.GUI.copyButton,c=i.text(),n=i.css("width");i.text(m.getMessage("cliCopySuccessful")),i.css({width:n,textAlign:"center"}),setTimeout(()=>{i.text(c),i.css({width:"",textAlign:""})},1500)}function o(i){console.warn(i)}L.writeText(t,e,o)}d.initialize=function(t){const e=this;y.active_tab!=="cli"&&(y.active_tab="cli"),e.outputHistory="",e.cliBuffer="",e.startProcessing=!1;const o=13;function i(){e.outputHistory="",e.GUI.windowWrapper.empty()}function c(n){e.history.add(n.trim());const a=n.split(`
`);return a.reduce((l,r,g)=>l.then(w=>new Promise(f=>{y.timeout_add("CLI_send_slowly",function(){let p=e.lineDelayMs;r=r.trim(),r.toLowerCase().startsWith("profile")&&(p=e.profileSwitchDelayMs),a.length===g+1&&e.cliBuffer&&(r=x(r,e.cliBuffer)),e.sendLine(r,function(){f(p)})},w)})),Promise.resolve(0))}s("#content").load("./tabs/cli.html",function(){m.localizePage(),C.cli.adaptPhones(),h.cliActive=!0,e.GUI.copyButton=s(".tab-cli .copy"),e.GUI.windowWrapper=s(".tab-cli .window .wrapper");const n=s('.tab-cli textarea[name="commands"]');u.initialize(n,e.sendLine.bind(e),v),s(u).on("build:start",function(){n.val("").attr("placeholder",m.getMessage("cliInputPlaceholderBuilding")).prop("disabled",!0)}),s(u).on("build:stop",function(){n.attr("placeholder",m.getMessage("cliInputPlaceholder")).prop("disabled",!1).focus()}),s(".tab-cli .save").click(function(){const a="cli",l="txt",r=_(a,l),g=[{description:`${l.toUpperCase()} files`,extensions:[l]}];chrome.fileSystem.chooseEntry({type:"saveFile",suggestedName:r,accepts:g},function(w){if(!A()){if(!w){console.log("No file selected");return}w.createWriter(function(f){f.onerror=function(){console.error("Failed to write file")},f.onwriteend=function(){e.outputHistory.length>0&&f.length===0?f.write(new Blob([e.outputHistory],{type:"text/plain"})):(b.sendEvent(b.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"CliSave",e.outputHistory.length),console.log("write complete"))},f.truncate(0)},function(){console.error("Failed to get file writer")})}})}),s(".tab-cli .clear").click(function(){i()}),L.available?e.GUI.copyButton.click(function(){O(e.outputHistory)}):e.GUI.copyButton.hide(),s(".tab-cli .load").click(function(){const a=[{description:"Config files",extensions:["txt","config"]},{description:"All files"}];chrome.fileSystem.chooseEntry({type:"openFile",accepts:a},function(l){if(A())return;const r=s("#snippetpreviewcontent textarea#preview");function g(f){const p=r.val();b.sendEvent(b.EVENT_CATEGORIES.FLIGHT_CONTROLLER,"CliExecuteFromFile",f),c(p),e.GUI.snippetPreviewWindow.close()}function w(f,p){e.GUI.snippetPreviewWindow||(e.GUI.snippetPreviewWindow=new U("Modal",{id:"snippetPreviewWindow",width:"auto",height:"auto",closeButton:"title",animation:!1,isolateScroll:!1,title:m.getMessage("cliConfirmSnippetDialogTitle",{fileName:p}),content:s("#snippetpreviewcontent"),onCreated:()=>s("#snippetpreviewcontent a.confirm").click(()=>g(p))})),r.val(f),e.GUI.snippetPreviewWindow.open()}l.file(f=>{const p=new FileReader;p.onload=()=>w(p.result,f.name),p.onerror=()=>console.error(p.error),p.readAsText(f)})})}),s(".tab-cli .support").toggle(navigator.onLine).on("click",function(){function a(l){i();const r=new R;r.getSupportCommands(g=>{g=[`###
# Problem description
# ${l}
###`,...g],c(g.join(`
`)).then(()=>{const w=setInterval(()=>{const f=new Date().getTime();if(e.lastArrival<f-250){clearInterval(w);const p=e.outputHistory;r.submitSupportData(p,B=>{v(m.getMessage("buildServerSupportRequestSubmission",[B]))})}},250)})})}e.supportWarningDialog(a)}),n.keydown(function(a){if(a.which===9)if(a.preventDefault(),u.isEnabled())!u.isOpen()&&!u.isBuilding()&&u.openLater(!0);else{const g=n.val().split(`
`).pop(),w=x(g,e.cliBuffer);w&&(e.sendNativeAutoComplete(w),n.val(""))}}),n.keypress(function(a){if(a.which===o){if(a.preventDefault(),u.isBuilding())return;const l=n.val();c(l),n.val("")}}),n.keyup(function(a){const l={38:!0},r={40:!0};u.isOpen()||(a.keyCode in l&&n.val(e.history.prev()),a.keyCode in r&&n.val(e.history.next()))}),n.focus(),y.timeout_add("enter_cli",function(){const l=new ArrayBuffer(1),r=new Uint8Array(l);r[0]=35,E.send(l)},250),y.content_ready(t)})};d.adaptPhones=function(){if(s(window).width()<575){const t=s(".note").height()+22+38;s(".backdrop").css("height",`calc(100% - ${t}px)`)}y.isCordova()&&G.initToolbar()};d.history={history:[],index:0};d.history.add=function(t){this.history.push(t),this.index=this.history.length};d.history.prev=function(){return this.index>0&&(this.index-=1),this.history[this.index]};d.history.next=function(){return this.index<this.history.length&&(this.index+=1),this.history[this.index-1]};const F=8,I=10,S=13;function v(t){C.cli.GUI.windowWrapper.append(t);const e=s(".tab-cli .window");e.scrollTop(e.prop("scrollHeight"))}function k(t){if(u.isBuilding()){u.builderParseLine(t);return}t.startsWith("###ERROR")?v(`<span class="error_message">${t}</span><br>`):v(`${t}<br>`)}function M(t){s(".tab-cli textarea").val(t)}d.read=function(t){const e=new Uint8Array(t.data);let o="",i=0;for(let c=0;c<e.length;c++){const n=String.fromCharCode(e[c]),a=n.charCodeAt()===I||n.charCodeAt()===S;if(!h.cliValid&&(a||this.startProcessing)){this.startProcessing=!0,o+=n,v(n);continue}const l=27,r=3;if(e[c]===l&&!i&&(i=r),i){i--;continue}if(h.cliValid)switch(e[c]){case I:y.operating_system==="Windows"&&(k(this.cliBuffer),this.cliBuffer="");break;case S:y.operating_system!=="Windows"&&(k(this.cliBuffer),this.cliBuffer="");break;case 60:this.cliBuffer+="&lt";break;case 62:this.cliBuffer+="&gt";break;case F:this.cliBuffer=this.cliBuffer.slice(0,-1),this.outputHistory=this.outputHistory.slice(0,-1);continue;default:this.cliBuffer+=n}u.isBuilding()||(this.outputHistory+=n),this.cliBuffer==="Rebooting"&&(h.cliActive=!1,h.cliValid=!1,T(m.getMessage("cliReboot")),W())}if(this.lastArrival=new Date().getTime(),!h.cliValid&&o.indexOf("CLI")!==-1){T(m.getMessage("cliEnter")),h.cliValid=!0;const c=o.split(`
`).pop();this.outputHistory=c,u.isEnabled()&&!u.isBuilding()&&u.builderStart()}u.isEnabled()||M(P(this.cliBuffer))};d.sendLine=function(t,e){this.send(`${t}
`,e)};d.sendNativeAutoComplete=function(t,e){this.send(`${t}	`,e)};d.send=function(t,e){const o=new ArrayBuffer(t.length),i=new Uint8Array(o);for(let c=0;c<t.length;c++)i[c]=t.charCodeAt(c);E.send(o,e)};d.supportWarningDialog=function(t){const e=s(".supportWarningDialog")[0],o=s('.tab-cli textarea[name="supportWarningDialogInput"]');e.hasAttribute("open")||(e.showModal(),s(".cancel").on("click",function(){e.close()}),s(".submit").on("click",function(){e.close(),t(o.val()),o.val("")}))};d.cleanup=function(t){if(C.cli.GUI.snippetPreviewWindow&&(C.cli.GUI.snippetPreviewWindow.destroy(),C.cli.GUI.snippetPreviewWindow=null),!(h.connectionValid&&h.cliValid&&h.cliActive)){t&&t();return}this.send(x("exit\r",this.cliBuffer),function(){W(function(){y.timeout_add("tab_change_callback",t,500)})}),h.cliActive=!1,h.cliValid=!1,u.cleanup(),s(u).off()};C.cli=d;export{d as cli};
